<% content_for :title, "新しい本を追加" %>

<div class="container">
  <h1>新しい本を追加</h1>

  <%= form_with model: @book, local: true, html: { class: "book-form" } do |form| %>
    <% if @book.errors.any? %>
      <div class="error-messages">
        <h4><%= pluralize(@book.errors.count, "error") %> prohibited this book from being saved:</h4>
        <ul>
          <% @book.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="form-group">
      <%= form.label :title, "書籍名 *", class: "form-label" %>
      <%= form.text_field :title, class: "form-control", required: true %>
    </div>

    <div class="form-group">
      <%= form.label :author, "著者 *", class: "form-label" %>
      <%= form.text_field :author, class: "form-control", required: true %>
    </div>

    <div class="form-group">
      <%= form.label :finished_date, "読了日 *", class: "form-label" %>
      <%= form.date_field :finished_date, class: "form-control", required: true %>
    </div>

    <div class="form-group">
      <%= form.label :publisher, "出版社", class: "form-label" %>
      <%= form.text_field :publisher, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= form.label :isbn, "ISBN", class: "form-label" %>
      <%= form.text_field :isbn, class: "form-control", maxlength: 13 %>
    </div>

    <div class="form-group">
      <%= form.label :price, "価格（円）", class: "form-label" %>
      <%= form.number_field :price, class: "form-control", min: 0 %>
    </div>

    <div class="form-group">
      <%= form.label :rating, "評価（1-10）", class: "form-label" %>
      <div class="rating-input">
        <%= form.range_field :rating, class: "form-range", min: 1, max: 10, step: 1, id: "rating-input", value: 5 %>
        <div class="rating-display">
          <span id="rating-value">5</span>/10
          <span id="rating-stars" class="stars"></span>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <%= form.submit "保存", class: "btn btn-primary" %>
      <%= link_to "キャンセル", books_path, class: "btn btn-secondary" %>
    </div>
  <% end %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const ratingInput = document.getElementById('rating-input');
  const ratingValue = document.getElementById('rating-value');
  const ratingStars = document.getElementById('rating-stars');

  function updateRatingDisplay(rating) {
    const numRating = parseInt(rating);
    ratingValue.textContent = numRating;
    
    // より視覚的な星の表示
    const fullStars = '★'.repeat(numRating);
    const emptyStars = '☆'.repeat(10 - numRating);
    ratingStars.textContent = fullStars + emptyStars;
    
    // 評価に応じて色も変更
    if (numRating >= 8) {
      ratingStars.style.color = '#ff6b35'; // オレンジ（高評価）
    } else if (numRating >= 6) {
      ratingStars.style.color = '#ffc107'; // 黄色（中評価）
    } else {
      ratingStars.style.color = '#6c757d'; // グレー（低評価）
    }
  }

  if (ratingInput) {
    // 初期値の設定（デフォルト5）
    const initialRating = parseInt(ratingInput.value) || 5;
    updateRatingDisplay(initialRating);

    // スライダーのリアルタイム更新（inputイベント）
    ratingInput.addEventListener('input', function() {
      updateRatingDisplay(parseInt(this.value));
    });

    // 値確定時の更新（changeイベント）
    ratingInput.addEventListener('change', function() {
      updateRatingDisplay(parseInt(this.value));
    });

    // マウスやキーボード操作への対応強化
    ratingInput.addEventListener('mousemove', function() {
      if (document.activeElement === this) {
        updateRatingDisplay(parseInt(this.value));
      }
    });
  }

  // フォームバリデーション
  const form = document.querySelector('.book-form');
  if (form) {
    form.addEventListener('submit', function(e) {
      const title = document.querySelector('#book_title').value.trim();
      const author = document.querySelector('#book_author').value.trim();
      const finishedDate = document.querySelector('#book_finished_date').value;

      if (!title || !author || !finishedDate) {
        e.preventDefault();
        alert('必須項目を入力してください。');
        return false;
      }

      const isbn = document.querySelector('#book_isbn').value.trim();
      if (isbn && isbn.length > 13) {
        e.preventDefault();
        alert('ISBNは13文字以下で入力してください。');
        return false;
      }

      const price = document.querySelector('#book_price').value;
      if (price && price < 0) {
        e.preventDefault();
        alert('価格は0以上の値を入力してください。');
        return false;
      }
    });
  }
});
</script>